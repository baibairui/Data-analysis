## 数据缺失值的填补
### 缺失值

数据准备过程中约70%的工作量是由于需要解决数据质量问题，其中缺失值和特殊值问题尤为突出。处理这些问题不仅对于保持数据的完整性至关重要，而且对于确保后续数据分析的准确性也非常关键。<br>


#### 缺失值的概念

- **数据库中的NULL值**：直接表示数据缺失。
- **特殊数值**：如系统中使用-999表示数值不存在，需要特别注意这些代表缺失的特殊数值。

#### 缺失值产生的原因

1. **机械原因**：数据收集或保存失败，如存储器损坏。
2. **人为原因**：主观失误、历史局限或有意隐瞒，如调查中的无效回答。

#### 缺失数据的类型

正确识别缺失数据的类型对于选择合适的处理方法至关重要。不同类型的缺失数据处理方法包括删除缺失数据、数据插补（如均值插补、回归插补、多重插补等）、模型基础方法（如使用具有缺失数据处理能力的统计模型）等。每种方法都有其优点和局限性，选择哪一种方法取决于缺失数据的类型、数据的特性以及研究的目的。

在数据分析和处理中，根据缺失数据发生的机制，主要分为以下三种类型，它们对数据分析的影响和处理方式有所不同：

- **完全随机缺失（MCAR, Missing Completely At Random）**<br>
数据的缺失与任何数据（无论是观测到的还是未观测到的）都无关。也就是说，缺失是完全随机的。在这种情况下，缺失的数据不会对数据分析造成偏差。例如，在一项问卷调查中，由于某些受访者随机忘记回答某个问题，导致数据缺失。<br>

- **随机缺失（MAR, Missing At Random）**<br>
数据的缺失与观测到的数据有关，但与未观测到的数据无关。也就是说，某个数据的缺失可能与另一些已知的数据有关系，但与缺失的数据本身的值无关。例如，在一项对工作满意度的调查中，年龄较大的人可能更不愿意透露自己的工资，这里的工资数据缺失与年龄（一个观测到的变量）有关。

- **非随机缺失（MNAR, Missing Not At Random）**<br>
数据的缺失与未观测到的数据有关，即某个数据的缺失是由于这个数据本身的值决定的。这种类型的缺失数据处理起来最为复杂，因为缺失数据的机制和缺失的数据本身相关联。例如，如果一项调查中，低收入者不愿意报告自己的收入，那么收入的缺失就与收入的实际值有关.<br>

##### 缺失数据类型判断

- **缺失值的统计**<br>
    1.计算每个变量的缺失值比例以及整个数据集的缺失比例
    
    2.通过可视化方法，例如热图（heatmap）、缺失值条形图（missing bar plot）等，直观地展现缺失值的分布情况。<br>


- **单变量分析**<br>
    1.分析各个单一变量的分布情况，包括中心位置（均值、中位数）和分布形态（标准差、偏度、峰度）。
    2.制作直方图、箱形图等图表，直观了解变量的分布情况和潜在的异常值。<br>

- **双变量分析**<br>
    1.通过散点图、相关系数等方法，分析变量之间的关系。
    2.对于分类变量，可以使用列联表（contingency table）和堆叠柱状图来查看类别之间的关系。<br>

- **缺失值模式分析**<br>
    1.分析缺失值是否随机分布，以及缺失值与其他变量是否存在某种关系。
    2.利用相关系数矩阵，看缺失值与其他变量是否有统计上的相关性。

- **多变量分析**<br>
    1.运用因子分析、聚类分析等方法，探索变量之间更复杂的结构性关系。
    2.使用多维缩放（MDS）、主成分分析（PCA）等降维技术，以减少数据的复杂性。

- **时间序列分析**<br>
    1.分析时间序列的趋势、季节性和周期性。
    2.识别时间序列中的缺失值模式，如缺失是否存在周期性。

## 缺失值处理方法

一般来说，用一个常数填充缺失值通常不是最佳选择。建立基于数据分布的模型来填充缺失值通常效果更好
下面是常用的一些填补缺失值的方法，这个数据集我们是使用的Knn填补<br>

### 使用0值填补缺失值

**概述**  
在数据预处理时，将缺失值填补为0是一种简单直接的方法。这种方法假设缺失值的实际意义是“无”或“没有发生”，适用于那些可以将缺失解释为“不存在”的场合。

#### 何时使用0值填补

- **适用情境**：数据中的缺失表示没有或为空。
- **计数和频率数据**：在计数或频率数据中，0可以表示“未观察到”事件。
- **需要特别标记**：在某些机器学习模型中，0可以作为一种特别的标记，明确表示信息的缺失。

#### 方法步骤

##### 1. 确定适用性
评估数据集和上下文，确定是否适合使用0值填补缺失值。

##### 2. 填补缺失值
直接将缺失值替换为0。<br>

### 使用上一个数填补缺失值

**概述**  
在处理时间序列数据或具有自然排序的数据集时，一种常见的填补缺失值的方法是使用前一个观测值来替换缺失值。这种方法假设数据具有连续性，且相邻的观测值之间差异不大。

#### 何时使用前一个值填补

- **时间序列数据**：数据点是按时间顺序排列的。
- **自然排序数据**：数据点之间存在逻辑上的顺序关系。
- **连续性假设**：假设数据点之间的值变化平滑，没有突变。

#### 方法步骤

##### 1. 排序数据（如果需要）
确保数据是按照正确的顺序排序的，特别是在处理时间序列数据时，这一点非常重要。

##### 2. 填补缺失值
将每个缺失值替换为其前一个非缺失值。<br>

### 使用平均数填补缺失值

**概述**  
在数据集中，数值型特征的缺失值可以通过多种方法进行填补。使用平均数填补是其中一种简单直接的方法，适用于那些假定数据分布大致呈正态分布且没有极端值（异常值）的情况。

#### 何时使用平均数填补

- **数值型数据**：适用于连续的数值型数据特征。
- **数据缺失随机**：当数据缺失是随机发生的，不是系统性缺失时。
- **无极端值影响**：当数据中没有极端值，或者极端值对整体分布影响不大时。

##### 方法步骤

###### 1. 计算平均数
计算数据集中每个数值型特征的平均数（算术均值）。

##### 2. 替换缺失值
将每个数值型特征中的缺失值替换为该特征的平均数<br>

### 使用众数填补缺失值

**概述**  
在数据预处理过程中，填补缺失值是常见的任务，尤其是当数据集在进行机器学习算法训练之前需要完整无缺时。使用众数（即最常见的值）来填补缺失值是处理分类数据的一种简便方法。

#### 何时使用众数填补

- **分类数据**：当数据是分类的（非连续的），且存在一个或多个高频出现的类别时。
- **无明显中心趋势**：当数据没有明显的平均值或中位数时，众数成为表示中心趋势的一个合理选择。
- **避免影响分布**：使用众数可以在一定程度上避免改变原始数据的分布。

#### 方法步骤

##### 1. 确定众数
计算数据集中每个分类变量的频率分布，并确定每个变量的众数。

##### 2. 替换缺失值
对于含有缺失值的每个分类变量，将缺失值替换为该变量的众数。<br>

### 使用K最近邻（KNN）填补缺失数据
后面有对knn的具体描述,这个数据集是用knn填补的缺失值<br>
**概述**  
K最近邻（KNN）是一种简单而有效的算法，不仅可以用于分类或回归问题，还可以用于数据预处理，比如填补缺失值。利用KNN填补缺失值涉及到找到缺失值数据点的K个最近邻居，并用这些邻居的相应特征值来估计缺失值。<br>
![image](https://github.com/baibairui/stock_pridict/assets/123094711/83ac6dd4-125c-427d-9084-3ede07ebbc01)

#### 关键步骤

#### 1. 确定K值
选择合适的K值是使用KNN填补缺失值的关键。K值过小可能会受到异常值的影响，而K值过大则可能会引入过多的变异性。通常情况下，K值的选择可以通过交叉验证来确定。

#### 2. 选择距离度量
确定衡量数据点间相似度的距离度量。常见的选择包括欧氏距离、曼哈顿距离等。

#### 3. 找到最近邻居
对于含有缺失值的数据点，找到其在已知数据集中的K个最近邻居。只有完整的数据点才能被考虑作为邻居。

#### 4. 计算缺失值
根据找到的邻居来估算缺失值。对于连续特征，可以使用邻居值的平均值或加权平均值；对于分类特征，可以使用模式（最频繁出现的值）。<br>

### 使用BP神经网络填补数据

**概述**  
BP神经网络，即反向传播神经网络，是一种监督学习算法，用于训练多层前馈神经网络。通过训练过程中的错误反向传播，网络能够学习并改进其预测。这种方法也可用于填补数据集中的缺失值，特别是在缺失模式复杂或数据集非线性时。<br>

![image](https://github.com/baibairui/stock_pridict/assets/123094711/112579ab-c04e-4d48-aedd-2ae6d083ae8e)

#### 关键步骤

##### 1. 数据预处理
在训练BP神经网络之前，重要的是首先对数据进行预处理。这包括标准化或归一化数据，以使网络更容易学习。

##### 2. 设计神经网络
选择合适的网络架构，包括输入层、一个或多个隐藏层以及输出层。输入层的神经元数量应与完整数据集中的特征数量相匹配，输出层的神经元数量应与要预测的缺失值数量相同。

##### 3. 确定损失函数和优化器
定义损失函数来量化预测值与真实值之间的差异。常用的损失函数有均方误差（MSE）等。选择一个优化器，如SGD或Adam，来最小化损失函数。

##### 4. 训练网络
使用包含缺失值的数据集进行训练。为了训练网络填补缺失值，可以使用仅包含已知值的特征来预测缺失的特征值。

##### 5. 填补缺失值
一旦网络训练完毕，使用它来预测缺失的数据点。网络的输出可以作为填补缺失值的估计。<br>

### 热卡填充（Hot Deck Imputation）

**概述**  
热卡填充是一种用于处理缺失数据的方法，它通过在数据集中找到一个与含有缺失值的对象最相似的完整对象，并用这个相似对象的值来填补缺失值。这种方法在概念上很简单，能够有效地利用数据间的内在关联性进行缺失值估计。

#### 方法特点

- **利用相似性**：基于相似性寻找最佳替代值，以保持数据的一致性和准确性。
- **主观性**：相似性标准的定义可能包含主观判断，不同问题可能需要不同的相似性标准。
- **灵活性**：可以根据具体问题调整相似性的定义和寻找最近邻的方法。

#### 应用步骤

##### 1. 定义相似性标准
根据数据的特性和分析的需要，定义一个合理的相似性标准。这可以基于某些关键特征，如性别、年龄等，也可以是基于复杂的距离度量，如欧氏距离或余弦相似性。

##### 2. 寻找最相似的对象
对于每个含有缺失值的对象，根据定义的相似性标准，在数据集中找到一个最相似的完整对象。

##### 3. 填补缺失值
使用找到的最相似对象的值来填补缺失值。

#### 缺点和考虑因素

- **定义相似性的难度**：在不同的问题和数据集中，定义一个合适的相似性标准可能很有挑战。
- **计算复杂性**：对于大型数据集，寻找最相似对象可能会很耗时。
- **数据代表性**：所选择的最相似对象可能不完全代表缺失值的真实情况。

#### 示例场景

- 在医疗数据分析中，可以使用热卡填充来填补患者记录中的缺失值，如通过性别、年龄和其他健康指标来寻找最相似的患者记录。
- 在客户调研数据中，对于缺失的调研回应，可以根据客户的人口统计信息和以往的调研回应来找到最相似的客户填补缺失值。

热卡填充提供了一种实用的方法来处理缺失数据，尤其是在缺失数据较少且能够定义出合理的相似性标准时。然而，它的成功应用需要对数据有深入的了解和仔细的考量。

### 多重填补（Multiple Imputation, MI）

**概述**  
多重填补（MI）是一种基于贝叶斯估计理念的缺失数据处理方法。它通过为每个缺失值生成多个可能的填补值来创建几个完整的数据集，然后对这些数据集分别进行分析，并最终综合分析结果以考虑因数据缺失而产生的不确定性。<br>
![image](https://github.com/baibairui/stock_pridict/assets/123094711/f8d05255-a810-4895-be0c-3614c3bfd564)

#### 方法原理

- **思想来源**：MI的核心思想来源于贝叶斯估计，认为待填补的值是随机的，由已观测到的值生成。
- **实践方法**：具体实践中，先估计出待填补的值，然后加上不同的噪声，形成多组可选填补值。通过某种标准选择最合适的填补值。

#### 多重填补步骤

1. **生成填补值**：为每个空值生成一套可能的填补值，这些值反映了无响应模型的不确定性。
2. **创建完整数据集**：使用生成的填补值填补缺失值，产生若干个完整的数据集合。
3. **进行统计分析**：对每个填补的数据集进行统计分析。
4. **综合分析结果**：将各个填补数据集的结果综合起来，产生最终的统计推断，考虑到了由于数据填补而产生的不确定性。

#### 应用实例

假设一组数据包含三个变量Y1，Y2，Y3，它们的联合分布为正态分布。在多值插补时，对不同组别的缺失模式（如B组缺失Y3，C组缺失Y1和Y2）采取不同的填补策略。

#### 考虑因素

- **模型形式**：贝叶斯估计要求模型形式准确，而多重插补基于大样本理论，对先验分布的准确性要求不高。
- **参数间关系**：多重插补利用参数间的相互关系进行估计，与贝叶斯估计相比，它能更好地利用参数之间的联系。

#### 优点

- 弥补了贝叶斯估计的不足，尤其是在大数据场景下，先验分布对结果的影响较小。
- 利用了参数间的相互关系，比贝叶斯估计更能体现参数之间的依赖性。

#### 缺点

- 计算复杂性高，需要生成多个完整数据集并对每个数据集进行分析。
- 定义相似性标准可能包含主观判断，不同问题可能需要不同的相似性标准。

多重插补是一种有效处理缺失数据的方法，尤其适用于缺失数据量大且缺失模式复杂的数据集。通过综合考虑多个可能的填补值，MI能够更准确地反映数据的不确定性，为后续分析提供稳健的基础。<br>